<!DOCTYPE html>
<html lang="en-US">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="http://localhost:1313/images/favicon.png" />
<title>使用 cloudflare 反代 gravatar 生成镜像 | Hugo ʕ•ᴥ•ʔ Bear Blog</title>
<meta name="title" content="使用 cloudflare 反代 gravatar 生成镜像" />
<meta name="description" content="1.介绍
cloudflare 有一个非常好用的功能&mdash;Workers，可以在无服务器的状态下运行一些程序，包括常见的反向代理等。
所以我利用这一功能实现对 gravatar 反代，达到国内访问加速的目的。
话不多说，开始流程操作，分享我的部署过程。
1.登陆后，在主页点击左侧的 Workers，然后点击创建服务。

2.服务名称随意填写，然后点击右下角创建。

3.点击右上角快速编辑

4.在左侧编辑器中输入下列的代码

2.代码

  1// 替换成你想镜像的站点
  2const upstream = &#39;gravatar.com&#39;
  3 
  4// 如果那个站点有专门的移动适配站点，否则保持和上面一致
  5const upstream_mobile = &#39;gravatar.com&#39;
  6 
  7// 你希望禁止哪些国家访问
  8const blocked_region = []
  9 
 10// 禁止自访问
 11const blocked_ip_address = []
 12 
 13// 替换成你想镜像的站点
 14const replace_dict = {
 15    &#39;$upstream&#39;: &#39;$custom_domain&#39;,
 16    &#39;//gravatar.com&#39;: &#39;&#39;
 17}
 18 
 19//以下内容都不用动
 20addEventListener(&#39;fetch&#39;, event =&gt; {
 21    event.respondWith(fetchAndApply(event.request));
 22})
 23 
 24async function fetchAndApply(request) {
 25 
 26    const region = request.headers.get(&#39;cf-ipcountry&#39;).toUpperCase();
 27    const ip_address = request.headers.get(&#39;cf-connecting-ip&#39;);
 28    const user_agent = request.headers.get(&#39;user-agent&#39;);
 29 
 30    let response = null;
 31    let url = new URL(request.url);
 32    let url_host = url.host;
 33 
 34    if (url.protocol == &#39;http:&#39;) {
 35        url.protocol = &#39;https:&#39;
 36        response = Response.redirect(url.href);
 37        return response;
 38    }
 39 
 40    if (await device_status(user_agent)) {
 41        upstream_domain = upstream
 42    } else {
 43        upstream_domain = upstream_mobile
 44    }
 45 
 46    url.host = upstream_domain;
 47 
 48    if (blocked_region.includes(region)) {
 49        response = new Response(&#39;Access denied: WorkersProxy is not available in your region yet.&#39;, {
 50            status: 403
 51        });
 52    } else if(blocked_ip_address.includes(ip_address)){
 53        response = new Response(&#39;Access denied: Your IP address is blocked by WorkersProxy.&#39;, {
 54            status: 403
 55        });
 56    } else{
 57        let method = request.method;
 58        let request_headers = request.headers;
 59        let new_request_headers = new Headers(request_headers);
 60 
 61        new_request_headers.set(&#39;Host&#39;, upstream_domain);
 62        new_request_headers.set(&#39;Referer&#39;, url.href);
 63 
 64        let original_response = await fetch(url.href, {
 65            method: method,
 66            headers: new_request_headers
 67        })
 68 
 69        let original_response_clone = original_response.clone();
 70        let original_text = null;
 71        let response_headers = original_response.headers;
 72        let new_response_headers = new Headers(response_headers);
 73        let status = original_response.status;
 74 
 75        new_response_headers.set(&#39;access-control-allow-origin&#39;, &#39;*&#39;);
 76        new_response_headers.set(&#39;access-control-allow-credentials&#39;, true);
 77        new_response_headers.delete(&#39;content-security-policy&#39;);
 78        new_response_headers.delete(&#39;content-security-policy-report-only&#39;);
 79        new_response_headers.delete(&#39;clear-site-data&#39;);
 80 
 81        const content_type = new_response_headers.get(&#39;content-type&#39;);
 82        if (content_type.includes(&#39;text/html&#39;) &amp;&amp; content_type.includes(&#39;UTF-8&#39;)) {
 83            original_text = await replace_response_text(original_response_clone, upstream_domain, url_host);
 84        } else {
 85            original_text = original_response_clone.body
 86        }
 87 
 88        response = new Response(original_text, {
 89            status,
 90            headers: new_response_headers
 91        })
 92    }
 93    return response;
 94}
 95 
 96async function replace_response_text(response, upstream_domain, host_name) {
 97    let text = await response.text()
 98 
 99    var i, j;
100    for (i in replace_dict) {
101        j = replace_dict[i]
102        if (i == &#39;$upstream&#39;) {
103            i = upstream_domain
104        } else if (i == &#39;$custom_domain&#39;) {
105            i = host_name
106        }
107 
108        if (j == &#39;$upstream&#39;) {
109            j = upstream_domain
110        } else if (j == &#39;$custom_domain&#39;) {
111            j = host_name
112        }
113 
114        let re = new RegExp(i, &#39;g&#39;)
115        text = text.replace(re, j);
116    }
117    return text;
118}
119 
120async function device_status (user_agent_info) {
121    var agents = [&#34;Android&#34;, &#34;iPhone&#34;, &#34;SymbianOS&#34;, &#34;Windows Phone&#34;, &#34;iPad&#34;, &#34;iPod&#34;];
122    var flag = true;
123    for (var v = 0; v &lt; agents.length; v&#43;&#43;) { if (user_agent_info.indexOf(agents[v]) &gt; 0) {
124            flag = false;
125            break;
126        }
127    }
128    return flag;
129}

然后点击保存并部署，就可以成功反代 gravatar 镜像了。" />
<meta name="keywords" content="cloudflare,gravatar," />


<meta property="og:url" content="http://localhost:1313/182/">
  <meta property="og:site_name" content="Hugo ʕ•ᴥ•ʔ Bear Blog">
  <meta property="og:title" content="使用 cloudflare 反代 gravatar 生成镜像">
  <meta property="og:description" content="1.介绍 cloudflare 有一个非常好用的功能—Workers，可以在无服务器的状态下运行一些程序，包括常见的反向代理等。
所以我利用这一功能实现对 gravatar 反代，达到国内访问加速的目的。
话不多说，开始流程操作，分享我的部署过程。
1.登陆后，在主页点击左侧的 Workers，然后点击创建服务。
2.服务名称随意填写，然后点击右下角创建。
3.点击右上角快速编辑
4.在左侧编辑器中输入下列的代码
2.代码 1// 替换成你想镜像的站点 2const upstream = &#39;gravatar.com&#39; 3 4// 如果那个站点有专门的移动适配站点，否则保持和上面一致 5const upstream_mobile = &#39;gravatar.com&#39; 6 7// 你希望禁止哪些国家访问 8const blocked_region = [] 9 10// 禁止自访问 11const blocked_ip_address = [] 12 13// 替换成你想镜像的站点 14const replace_dict = { 15 &#39;$upstream&#39;: &#39;$custom_domain&#39;, 16 &#39;//gravatar.com&#39;: &#39;&#39; 17} 18 19//以下内容都不用动 20addEventListener(&#39;fetch&#39;, event =&gt; { 21 event.respondWith(fetchAndApply(event.request)); 22}) 23 24async function fetchAndApply(request) { 25 26 const region = request.headers.get(&#39;cf-ipcountry&#39;).toUpperCase(); 27 const ip_address = request.headers.get(&#39;cf-connecting-ip&#39;); 28 const user_agent = request.headers.get(&#39;user-agent&#39;); 29 30 let response = null; 31 let url = new URL(request.url); 32 let url_host = url.host; 33 34 if (url.protocol == &#39;http:&#39;) { 35 url.protocol = &#39;https:&#39; 36 response = Response.redirect(url.href); 37 return response; 38 } 39 40 if (await device_status(user_agent)) { 41 upstream_domain = upstream 42 } else { 43 upstream_domain = upstream_mobile 44 } 45 46 url.host = upstream_domain; 47 48 if (blocked_region.includes(region)) { 49 response = new Response(&#39;Access denied: WorkersProxy is not available in your region yet.&#39;, { 50 status: 403 51 }); 52 } else if(blocked_ip_address.includes(ip_address)){ 53 response = new Response(&#39;Access denied: Your IP address is blocked by WorkersProxy.&#39;, { 54 status: 403 55 }); 56 } else{ 57 let method = request.method; 58 let request_headers = request.headers; 59 let new_request_headers = new Headers(request_headers); 60 61 new_request_headers.set(&#39;Host&#39;, upstream_domain); 62 new_request_headers.set(&#39;Referer&#39;, url.href); 63 64 let original_response = await fetch(url.href, { 65 method: method, 66 headers: new_request_headers 67 }) 68 69 let original_response_clone = original_response.clone(); 70 let original_text = null; 71 let response_headers = original_response.headers; 72 let new_response_headers = new Headers(response_headers); 73 let status = original_response.status; 74 75 new_response_headers.set(&#39;access-control-allow-origin&#39;, &#39;*&#39;); 76 new_response_headers.set(&#39;access-control-allow-credentials&#39;, true); 77 new_response_headers.delete(&#39;content-security-policy&#39;); 78 new_response_headers.delete(&#39;content-security-policy-report-only&#39;); 79 new_response_headers.delete(&#39;clear-site-data&#39;); 80 81 const content_type = new_response_headers.get(&#39;content-type&#39;); 82 if (content_type.includes(&#39;text/html&#39;) &amp;&amp; content_type.includes(&#39;UTF-8&#39;)) { 83 original_text = await replace_response_text(original_response_clone, upstream_domain, url_host); 84 } else { 85 original_text = original_response_clone.body 86 } 87 88 response = new Response(original_text, { 89 status, 90 headers: new_response_headers 91 }) 92 } 93 return response; 94} 95 96async function replace_response_text(response, upstream_domain, host_name) { 97 let text = await response.text() 98 99 var i, j; 100 for (i in replace_dict) { 101 j = replace_dict[i] 102 if (i == &#39;$upstream&#39;) { 103 i = upstream_domain 104 } else if (i == &#39;$custom_domain&#39;) { 105 i = host_name 106 } 107 108 if (j == &#39;$upstream&#39;) { 109 j = upstream_domain 110 } else if (j == &#39;$custom_domain&#39;) { 111 j = host_name 112 } 113 114 let re = new RegExp(i, &#39;g&#39;) 115 text = text.replace(re, j); 116 } 117 return text; 118} 119 120async function device_status (user_agent_info) { 121 var agents = [&#34;Android&#34;, &#34;iPhone&#34;, &#34;SymbianOS&#34;, &#34;Windows Phone&#34;, &#34;iPad&#34;, &#34;iPod&#34;]; 122 var flag = true; 123 for (var v = 0; v &lt; agents.length; v&#43;&#43;) { if (user_agent_info.indexOf(agents[v]) &gt; 0) { 124 flag = false; 125 break; 126 } 127 } 128 return flag; 129} 然后点击保存并部署，就可以成功反代 gravatar 镜像了。">
  <meta property="og:locale" content="en_US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2023-02-01T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-02-01T00:00:00+00:00">
    <meta property="article:tag" content="Cloudflare">
    <meta property="article:tag" content="Gravatar">
    <meta property="og:image" content="http://localhost:1313/images/share.png">




  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/images/share.png">
  <meta name="twitter:title" content="使用 cloudflare 反代 gravatar 生成镜像">
  <meta name="twitter:description" content="1.介绍 cloudflare 有一个非常好用的功能—Workers，可以在无服务器的状态下运行一些程序，包括常见的反向代理等。
所以我利用这一功能实现对 gravatar 反代，达到国内访问加速的目的。
话不多说，开始流程操作，分享我的部署过程。
1.登陆后，在主页点击左侧的 Workers，然后点击创建服务。
2.服务名称随意填写，然后点击右下角创建。
3.点击右上角快速编辑
4.在左侧编辑器中输入下列的代码
2.代码 1// 替换成你想镜像的站点 2const upstream = &#39;gravatar.com&#39; 3 4// 如果那个站点有专门的移动适配站点，否则保持和上面一致 5const upstream_mobile = &#39;gravatar.com&#39; 6 7// 你希望禁止哪些国家访问 8const blocked_region = [] 9 10// 禁止自访问 11const blocked_ip_address = [] 12 13// 替换成你想镜像的站点 14const replace_dict = { 15 &#39;$upstream&#39;: &#39;$custom_domain&#39;, 16 &#39;//gravatar.com&#39;: &#39;&#39; 17} 18 19//以下内容都不用动 20addEventListener(&#39;fetch&#39;, event =&gt; { 21 event.respondWith(fetchAndApply(event.request)); 22}) 23 24async function fetchAndApply(request) { 25 26 const region = request.headers.get(&#39;cf-ipcountry&#39;).toUpperCase(); 27 const ip_address = request.headers.get(&#39;cf-connecting-ip&#39;); 28 const user_agent = request.headers.get(&#39;user-agent&#39;); 29 30 let response = null; 31 let url = new URL(request.url); 32 let url_host = url.host; 33 34 if (url.protocol == &#39;http:&#39;) { 35 url.protocol = &#39;https:&#39; 36 response = Response.redirect(url.href); 37 return response; 38 } 39 40 if (await device_status(user_agent)) { 41 upstream_domain = upstream 42 } else { 43 upstream_domain = upstream_mobile 44 } 45 46 url.host = upstream_domain; 47 48 if (blocked_region.includes(region)) { 49 response = new Response(&#39;Access denied: WorkersProxy is not available in your region yet.&#39;, { 50 status: 403 51 }); 52 } else if(blocked_ip_address.includes(ip_address)){ 53 response = new Response(&#39;Access denied: Your IP address is blocked by WorkersProxy.&#39;, { 54 status: 403 55 }); 56 } else{ 57 let method = request.method; 58 let request_headers = request.headers; 59 let new_request_headers = new Headers(request_headers); 60 61 new_request_headers.set(&#39;Host&#39;, upstream_domain); 62 new_request_headers.set(&#39;Referer&#39;, url.href); 63 64 let original_response = await fetch(url.href, { 65 method: method, 66 headers: new_request_headers 67 }) 68 69 let original_response_clone = original_response.clone(); 70 let original_text = null; 71 let response_headers = original_response.headers; 72 let new_response_headers = new Headers(response_headers); 73 let status = original_response.status; 74 75 new_response_headers.set(&#39;access-control-allow-origin&#39;, &#39;*&#39;); 76 new_response_headers.set(&#39;access-control-allow-credentials&#39;, true); 77 new_response_headers.delete(&#39;content-security-policy&#39;); 78 new_response_headers.delete(&#39;content-security-policy-report-only&#39;); 79 new_response_headers.delete(&#39;clear-site-data&#39;); 80 81 const content_type = new_response_headers.get(&#39;content-type&#39;); 82 if (content_type.includes(&#39;text/html&#39;) &amp;&amp; content_type.includes(&#39;UTF-8&#39;)) { 83 original_text = await replace_response_text(original_response_clone, upstream_domain, url_host); 84 } else { 85 original_text = original_response_clone.body 86 } 87 88 response = new Response(original_text, { 89 status, 90 headers: new_response_headers 91 }) 92 } 93 return response; 94} 95 96async function replace_response_text(response, upstream_domain, host_name) { 97 let text = await response.text() 98 99 var i, j; 100 for (i in replace_dict) { 101 j = replace_dict[i] 102 if (i == &#39;$upstream&#39;) { 103 i = upstream_domain 104 } else if (i == &#39;$custom_domain&#39;) { 105 i = host_name 106 } 107 108 if (j == &#39;$upstream&#39;) { 109 j = upstream_domain 110 } else if (j == &#39;$custom_domain&#39;) { 111 j = host_name 112 } 113 114 let re = new RegExp(i, &#39;g&#39;) 115 text = text.replace(re, j); 116 } 117 return text; 118} 119 120async function device_status (user_agent_info) { 121 var agents = [&#34;Android&#34;, &#34;iPhone&#34;, &#34;SymbianOS&#34;, &#34;Windows Phone&#34;, &#34;iPad&#34;, &#34;iPod&#34;]; 122 var flag = true; 123 for (var v = 0; v &lt; agents.length; v&#43;&#43;) { if (user_agent_info.indexOf(agents[v]) &gt; 0) { 124 flag = false; 125 break; 126 } 127 } 128 return flag; 129} 然后点击保存并部署，就可以成功反代 gravatar 镜像了。">




  <meta itemprop="name" content="使用 cloudflare 反代 gravatar 生成镜像">
  <meta itemprop="description" content="1.介绍 cloudflare 有一个非常好用的功能—Workers，可以在无服务器的状态下运行一些程序，包括常见的反向代理等。
所以我利用这一功能实现对 gravatar 反代，达到国内访问加速的目的。
话不多说，开始流程操作，分享我的部署过程。
1.登陆后，在主页点击左侧的 Workers，然后点击创建服务。
2.服务名称随意填写，然后点击右下角创建。
3.点击右上角快速编辑
4.在左侧编辑器中输入下列的代码
2.代码 1// 替换成你想镜像的站点 2const upstream = &#39;gravatar.com&#39; 3 4// 如果那个站点有专门的移动适配站点，否则保持和上面一致 5const upstream_mobile = &#39;gravatar.com&#39; 6 7// 你希望禁止哪些国家访问 8const blocked_region = [] 9 10// 禁止自访问 11const blocked_ip_address = [] 12 13// 替换成你想镜像的站点 14const replace_dict = { 15 &#39;$upstream&#39;: &#39;$custom_domain&#39;, 16 &#39;//gravatar.com&#39;: &#39;&#39; 17} 18 19//以下内容都不用动 20addEventListener(&#39;fetch&#39;, event =&gt; { 21 event.respondWith(fetchAndApply(event.request)); 22}) 23 24async function fetchAndApply(request) { 25 26 const region = request.headers.get(&#39;cf-ipcountry&#39;).toUpperCase(); 27 const ip_address = request.headers.get(&#39;cf-connecting-ip&#39;); 28 const user_agent = request.headers.get(&#39;user-agent&#39;); 29 30 let response = null; 31 let url = new URL(request.url); 32 let url_host = url.host; 33 34 if (url.protocol == &#39;http:&#39;) { 35 url.protocol = &#39;https:&#39; 36 response = Response.redirect(url.href); 37 return response; 38 } 39 40 if (await device_status(user_agent)) { 41 upstream_domain = upstream 42 } else { 43 upstream_domain = upstream_mobile 44 } 45 46 url.host = upstream_domain; 47 48 if (blocked_region.includes(region)) { 49 response = new Response(&#39;Access denied: WorkersProxy is not available in your region yet.&#39;, { 50 status: 403 51 }); 52 } else if(blocked_ip_address.includes(ip_address)){ 53 response = new Response(&#39;Access denied: Your IP address is blocked by WorkersProxy.&#39;, { 54 status: 403 55 }); 56 } else{ 57 let method = request.method; 58 let request_headers = request.headers; 59 let new_request_headers = new Headers(request_headers); 60 61 new_request_headers.set(&#39;Host&#39;, upstream_domain); 62 new_request_headers.set(&#39;Referer&#39;, url.href); 63 64 let original_response = await fetch(url.href, { 65 method: method, 66 headers: new_request_headers 67 }) 68 69 let original_response_clone = original_response.clone(); 70 let original_text = null; 71 let response_headers = original_response.headers; 72 let new_response_headers = new Headers(response_headers); 73 let status = original_response.status; 74 75 new_response_headers.set(&#39;access-control-allow-origin&#39;, &#39;*&#39;); 76 new_response_headers.set(&#39;access-control-allow-credentials&#39;, true); 77 new_response_headers.delete(&#39;content-security-policy&#39;); 78 new_response_headers.delete(&#39;content-security-policy-report-only&#39;); 79 new_response_headers.delete(&#39;clear-site-data&#39;); 80 81 const content_type = new_response_headers.get(&#39;content-type&#39;); 82 if (content_type.includes(&#39;text/html&#39;) &amp;&amp; content_type.includes(&#39;UTF-8&#39;)) { 83 original_text = await replace_response_text(original_response_clone, upstream_domain, url_host); 84 } else { 85 original_text = original_response_clone.body 86 } 87 88 response = new Response(original_text, { 89 status, 90 headers: new_response_headers 91 }) 92 } 93 return response; 94} 95 96async function replace_response_text(response, upstream_domain, host_name) { 97 let text = await response.text() 98 99 var i, j; 100 for (i in replace_dict) { 101 j = replace_dict[i] 102 if (i == &#39;$upstream&#39;) { 103 i = upstream_domain 104 } else if (i == &#39;$custom_domain&#39;) { 105 i = host_name 106 } 107 108 if (j == &#39;$upstream&#39;) { 109 j = upstream_domain 110 } else if (j == &#39;$custom_domain&#39;) { 111 j = host_name 112 } 113 114 let re = new RegExp(i, &#39;g&#39;) 115 text = text.replace(re, j); 116 } 117 return text; 118} 119 120async function device_status (user_agent_info) { 121 var agents = [&#34;Android&#34;, &#34;iPhone&#34;, &#34;SymbianOS&#34;, &#34;Windows Phone&#34;, &#34;iPad&#34;, &#34;iPod&#34;]; 122 var flag = true; 123 for (var v = 0; v &lt; agents.length; v&#43;&#43;) { if (user_agent_info.indexOf(agents[v]) &gt; 0) { 124 flag = false; 125 break; 126 } 127 } 128 return flag; 129} 然后点击保存并部署，就可以成功反代 gravatar 镜像了。">
  <meta itemprop="datePublished" content="2023-02-01T00:00:00+00:00">
  <meta itemprop="dateModified" content="2023-02-01T00:00:00+00:00">
  <meta itemprop="wordCount" content="491">
  <meta itemprop="image" content="http://localhost:1313/images/share.png">
  <meta itemprop="keywords" content="Cloudflare,Gravatar">
<meta name="referrer" content="no-referrer-when-downgrade" />

  <style>
  :root {
    --width: 720px;
    --font-main: Verdana, sans-serif;
    --font-secondary: Verdana, sans-serif;
    --font-scale: 1em;
    --background-color: #fff;
    --heading-color: #222;
    --text-color: #444;
    --link-color: #3273dc;
    --visited-color: #8b6fcb;
    --code-background-color: #f2f2f2;
    --code-color: #222;
    --blockquote-color: #222;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --background-color: #01242e;
      --heading-color: #eee;
      --text-color: #ddd;
      --link-color: #8cc2dd;
      --visited-color: #8b6fcb;
      --code-background-color: #000;
      --code-color: #ddd;
      --blockquote-color: #ccc;
    }
  }

  body {
    font-family: var(--font-secondary);
    font-size: var(--font-scale);
    margin: auto;
    padding: 20px;
    max-width: var(--width);
    text-align: left;
    background-color: var(--background-color);
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    color: var(--text-color);
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-family: var(--font-main);
    color: var(--heading-color);
  }

  a {
    color: var(--link-color);
    cursor: pointer;
    text-decoration: none;
  }

  a:hover {
    text-decoration: underline;
  }

  nav a {
    margin-right: 8px;
  }

  strong,
  b {
    color: var(--heading-color);
  }

  button {
    margin: 0;
    cursor: pointer;
  }

  time {
    font-family: monospace;
    font-style: normal;
    font-size: 15px;
  }

  main {
    line-height: 1.6;
  }

  table {
    width: 100%;
  }

  hr {
    border: 0;
    border-top: 1px dashed;
  }

  img {
    max-width: 100%;
  }

  code {
    font-family: monospace;
    padding: 2px;
    background-color: var(--code-background-color);
    color: var(--code-color);
    border-radius: 3px;
  }

  blockquote {
    border-left: 1px solid #999;
    color: var(--code-color);
    padding-left: 20px;
    font-style: italic;
  }

  footer {
    padding: 25px 0;
    text-align: center;
  }

  .title:hover {
    text-decoration: none;
  }

  .title h1 {
    font-size: 1.5em;
  }

  .inline {
    width: auto !important;
  }

  .highlight,
  .code {
    padding: 1px 15px;
    background-color: var(--code-background-color);
    color: var(--code-color);
    border-radius: 3px;
    margin-block-start: 1em;
    margin-block-end: 1em;
    overflow-x: auto;
  }

   
  ul.blog-posts {
    list-style-type: none;
    padding: unset;
  }

  ul.blog-posts li {
    display: flex;
  }

  ul.blog-posts li span {
    flex: 0 0 130px;
  }

  ul.blog-posts li a:visited {
    color: var(--visited-color);
  }

</style>

</head>

<body>
  <header><a href="/" class="title">
  <h2>Hugo ʕ•ᴥ•ʔ Bear Blog</h2>
</a>
<nav>
</nav>
</header>
  <main>

<h1>使用 cloudflare 反代 gravatar 生成镜像</h1>
<p>
  <i>
    <time datetime='2023-02-01'>
      01 Feb, 2023
    </time>
  </i>
</p>

<content>
  <h2 id="1介绍">1.介绍</h2>
<p>cloudflare 有一个非常好用的功能&mdash;Workers，可以在无服务器的状态下运行一些程序，包括常见的反向代理等。</p>
<p>所以我利用这一功能实现对 gravatar 反代，达到国内访问加速的目的。</p>
<p>话不多说，开始流程操作，分享我的部署过程。</p>
<p><strong>1.登陆后，在主页点击左侧的 <code>Workers</code>，然后点击<code>创建服务</code>。</strong></p>
<p><img src="https://imgurl.zishu.me/images/old/20230201/1675253358798.5h6helivsl00.webp" alt=""></p>
<p><strong>2.服务名称随意填写，然后点击右下角创建。</strong></p>
<p><img src="https://imgurl.zishu.me/images/old/20230201/1675253485344.451pp9l8u920.webp" alt=""></p>
<p><strong>3.点击右上角快速编辑</strong></p>
<p><img src="https://imgurl.zishu.me/images/old/20230201/image.2ple8r24vra.webp" alt=""></p>
<p><strong>4.在左侧编辑器中输入下列的代码</strong></p>
<p><img src="https://imgurl.zishu.me/images/old/20230201/image.7hrwxy8aok00.webp" alt=""></p>
<h2 id="2代码">2.代码</h2>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1</span><span><span style="color:#60a0b0;font-style:italic">// 替换成你想镜像的站点
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2</span><span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">const</span> upstream <span style="color:#666">=</span> <span style="color:#4070a0">&#39;gravatar.com&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4</span><span><span style="color:#60a0b0;font-style:italic">// 如果那个站点有专门的移动适配站点，否则保持和上面一致
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5</span><span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">const</span> upstream_mobile <span style="color:#666">=</span> <span style="color:#4070a0">&#39;gravatar.com&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7</span><span><span style="color:#60a0b0;font-style:italic">// 你希望禁止哪些国家访问
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8</span><span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">const</span> blocked_region <span style="color:#666">=</span> []
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10</span><span><span style="color:#60a0b0;font-style:italic">// 禁止自访问
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11</span><span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">const</span> blocked_ip_address <span style="color:#666">=</span> []
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13</span><span><span style="color:#60a0b0;font-style:italic">// 替换成你想镜像的站点
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14</span><span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">const</span> replace_dict <span style="color:#666">=</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15</span><span>    <span style="color:#4070a0">&#39;$upstream&#39;</span><span style="color:#666">:</span> <span style="color:#4070a0">&#39;$custom_domain&#39;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16</span><span>    <span style="color:#4070a0">&#39;//gravatar.com&#39;</span><span style="color:#666">:</span> <span style="color:#4070a0">&#39;&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19</span><span><span style="color:#60a0b0;font-style:italic">//以下内容都不用动
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20</span><span><span style="color:#60a0b0;font-style:italic"></span>addEventListener(<span style="color:#4070a0">&#39;fetch&#39;</span>, event =&gt; {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21</span><span>    event.respondWith(fetchAndApply(event.request));
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22</span><span>})
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24</span><span><span style="color:#007020;font-weight:bold">async</span> <span style="color:#007020;font-weight:bold">function</span> fetchAndApply(request) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26</span><span>    <span style="color:#007020;font-weight:bold">const</span> region <span style="color:#666">=</span> request.headers.get(<span style="color:#4070a0">&#39;cf-ipcountry&#39;</span>).toUpperCase();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27</span><span>    <span style="color:#007020;font-weight:bold">const</span> ip_address <span style="color:#666">=</span> request.headers.get(<span style="color:#4070a0">&#39;cf-connecting-ip&#39;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28</span><span>    <span style="color:#007020;font-weight:bold">const</span> user_agent <span style="color:#666">=</span> request.headers.get(<span style="color:#4070a0">&#39;user-agent&#39;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30</span><span>    <span style="color:#007020;font-weight:bold">let</span> response <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31</span><span>    <span style="color:#007020;font-weight:bold">let</span> url <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> URL(request.url);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32</span><span>    <span style="color:#007020;font-weight:bold">let</span> url_host <span style="color:#666">=</span> url.host;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34</span><span>    <span style="color:#007020;font-weight:bold">if</span> (url.protocol <span style="color:#666">==</span> <span style="color:#4070a0">&#39;http:&#39;</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35</span><span>        url.protocol <span style="color:#666">=</span> <span style="color:#4070a0">&#39;https:&#39;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36</span><span>        response <span style="color:#666">=</span> Response.redirect(url.href);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37</span><span>        <span style="color:#007020;font-weight:bold">return</span> response;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40</span><span>    <span style="color:#007020;font-weight:bold">if</span> (<span style="color:#007020;font-weight:bold">await</span> device_status(user_agent)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41</span><span>        upstream_domain <span style="color:#666">=</span> upstream
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42</span><span>    } <span style="color:#007020;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43</span><span>        upstream_domain <span style="color:#666">=</span> upstream_mobile
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46</span><span>    url.host <span style="color:#666">=</span> upstream_domain;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48</span><span>    <span style="color:#007020;font-weight:bold">if</span> (blocked_region.includes(region)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49</span><span>        response <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> Response(<span style="color:#4070a0">&#39;Access denied: WorkersProxy is not available in your region yet.&#39;</span>, {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50</span><span>            status<span style="color:#666">:</span> <span style="color:#40a070">403</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51</span><span>        });
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52</span><span>    } <span style="color:#007020;font-weight:bold">else</span> <span style="color:#007020;font-weight:bold">if</span>(blocked_ip_address.includes(ip_address)){
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53</span><span>        response <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> Response(<span style="color:#4070a0">&#39;Access denied: Your IP address is blocked by WorkersProxy.&#39;</span>, {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54</span><span>            status<span style="color:#666">:</span> <span style="color:#40a070">403</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55</span><span>        });
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56</span><span>    } <span style="color:#007020;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57</span><span>        <span style="color:#007020;font-weight:bold">let</span> method <span style="color:#666">=</span> request.method;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58</span><span>        <span style="color:#007020;font-weight:bold">let</span> request_headers <span style="color:#666">=</span> request.headers;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59</span><span>        <span style="color:#007020;font-weight:bold">let</span> new_request_headers <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> Headers(request_headers);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61</span><span>        new_request_headers.set(<span style="color:#4070a0">&#39;Host&#39;</span>, upstream_domain);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62</span><span>        new_request_headers.set(<span style="color:#4070a0">&#39;Referer&#39;</span>, url.href);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64</span><span>        <span style="color:#007020;font-weight:bold">let</span> original_response <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">await</span> fetch(url.href, {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65</span><span>            method<span style="color:#666">:</span> method,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66</span><span>            headers<span style="color:#666">:</span> new_request_headers
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67</span><span>        })
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69</span><span>        <span style="color:#007020;font-weight:bold">let</span> original_response_clone <span style="color:#666">=</span> original_response.clone();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70</span><span>        <span style="color:#007020;font-weight:bold">let</span> original_text <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71</span><span>        <span style="color:#007020;font-weight:bold">let</span> response_headers <span style="color:#666">=</span> original_response.headers;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72</span><span>        <span style="color:#007020;font-weight:bold">let</span> new_response_headers <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> Headers(response_headers);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73</span><span>        <span style="color:#007020;font-weight:bold">let</span> status <span style="color:#666">=</span> original_response.status;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75</span><span>        new_response_headers.set(<span style="color:#4070a0">&#39;access-control-allow-origin&#39;</span>, <span style="color:#4070a0">&#39;*&#39;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76</span><span>        new_response_headers.set(<span style="color:#4070a0">&#39;access-control-allow-credentials&#39;</span>, <span style="color:#007020;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77</span><span>        new_response_headers.<span style="color:#007020;font-weight:bold">delete</span>(<span style="color:#4070a0">&#39;content-security-policy&#39;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78</span><span>        new_response_headers.<span style="color:#007020;font-weight:bold">delete</span>(<span style="color:#4070a0">&#39;content-security-policy-report-only&#39;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79</span><span>        new_response_headers.<span style="color:#007020;font-weight:bold">delete</span>(<span style="color:#4070a0">&#39;clear-site-data&#39;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81</span><span>        <span style="color:#007020;font-weight:bold">const</span> content_type <span style="color:#666">=</span> new_response_headers.get(<span style="color:#4070a0">&#39;content-type&#39;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82</span><span>        <span style="color:#007020;font-weight:bold">if</span> (content_type.includes(<span style="color:#4070a0">&#39;text/html&#39;</span>) <span style="color:#666">&amp;&amp;</span> content_type.includes(<span style="color:#4070a0">&#39;UTF-8&#39;</span>)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83</span><span>            original_text <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">await</span> replace_response_text(original_response_clone, upstream_domain, url_host);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84</span><span>        } <span style="color:#007020;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85</span><span>            original_text <span style="color:#666">=</span> original_response_clone.body
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88</span><span>        response <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> Response(original_text, {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89</span><span>            status,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90</span><span>            headers<span style="color:#666">:</span> new_response_headers
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91</span><span>        })
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93</span><span>    <span style="color:#007020;font-weight:bold">return</span> response;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96</span><span><span style="color:#007020;font-weight:bold">async</span> <span style="color:#007020;font-weight:bold">function</span> replace_response_text(response, upstream_domain, host_name) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97</span><span>    <span style="color:#007020;font-weight:bold">let</span> text <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">await</span> response.text()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99</span><span>    <span style="color:#007020;font-weight:bold">var</span> i, j;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100</span><span>    <span style="color:#007020;font-weight:bold">for</span> (i <span style="color:#007020;font-weight:bold">in</span> replace_dict) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101</span><span>        j <span style="color:#666">=</span> replace_dict[i]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102</span><span>        <span style="color:#007020;font-weight:bold">if</span> (i <span style="color:#666">==</span> <span style="color:#4070a0">&#39;$upstream&#39;</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103</span><span>            i <span style="color:#666">=</span> upstream_domain
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104</span><span>        } <span style="color:#007020;font-weight:bold">else</span> <span style="color:#007020;font-weight:bold">if</span> (i <span style="color:#666">==</span> <span style="color:#4070a0">&#39;$custom_domain&#39;</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105</span><span>            i <span style="color:#666">=</span> host_name
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108</span><span>        <span style="color:#007020;font-weight:bold">if</span> (j <span style="color:#666">==</span> <span style="color:#4070a0">&#39;$upstream&#39;</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109</span><span>            j <span style="color:#666">=</span> upstream_domain
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110</span><span>        } <span style="color:#007020;font-weight:bold">else</span> <span style="color:#007020;font-weight:bold">if</span> (j <span style="color:#666">==</span> <span style="color:#4070a0">&#39;$custom_domain&#39;</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111</span><span>            j <span style="color:#666">=</span> host_name
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114</span><span>        <span style="color:#007020;font-weight:bold">let</span> re <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> <span style="color:#007020">RegExp</span>(i, <span style="color:#4070a0">&#39;g&#39;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115</span><span>        text <span style="color:#666">=</span> text.replace(re, j);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117</span><span>    <span style="color:#007020;font-weight:bold">return</span> text;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119</span><span> 
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120</span><span><span style="color:#007020;font-weight:bold">async</span> <span style="color:#007020;font-weight:bold">function</span> device_status (user_agent_info) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121</span><span>    <span style="color:#007020;font-weight:bold">var</span> agents <span style="color:#666">=</span> [<span style="color:#4070a0">&#34;Android&#34;</span>, <span style="color:#4070a0">&#34;iPhone&#34;</span>, <span style="color:#4070a0">&#34;SymbianOS&#34;</span>, <span style="color:#4070a0">&#34;Windows Phone&#34;</span>, <span style="color:#4070a0">&#34;iPad&#34;</span>, <span style="color:#4070a0">&#34;iPod&#34;</span>];
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122</span><span>    <span style="color:#007020;font-weight:bold">var</span> flag <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123</span><span>    <span style="color:#007020;font-weight:bold">for</span> (<span style="color:#007020;font-weight:bold">var</span> v <span style="color:#666">=</span> <span style="color:#40a070">0</span>; v <span style="color:#666">&lt;</span> agents.length; v<span style="color:#666">++</span>) { <span style="color:#007020;font-weight:bold">if</span> (user_agent_info.indexOf(agents[v]) <span style="color:#666">&gt;</span> <span style="color:#40a070">0</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124</span><span>            flag <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125</span><span>            <span style="color:#007020;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128</span><span>    <span style="color:#007020;font-weight:bold">return</span> flag;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129</span><span>}
</span></span></code></pre></div><!-- raw HTML omitted -->
<p>然后点击<code>保存并部署</code>，就可以成功反代 gravatar 镜像了。</p>
<p>然后照葫芦画瓢，可以通过这种方式反代任何网站，访问起来大致无压力，延迟 100+ms 左右。</p>
<h2 id="3自定义域名">3.自定义域名</h2>
<p><img src="https://imgurl.zishu.me/images/old/20230201/1675254069096.51n0e9vl53g0.webp" alt=""></p>
<p>在触发器中可以找到自定义域名选项，输入已经绑定 cloudflare 的域名，再次赞美 cloudflare，如果事前绑定好了域名，在这里可以直接输入二级域名，cloudflare 会自动解析，全部都是自动化的。</p>
<p>在主页左侧的 <code>网站</code> 绑定域名。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#60a0b0;font-style:italic"># 分享我的免费镜像。</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>https://gravatar.zsh.im/avatar
</span></span></code></pre></div>
</content>
<p>
  
  <a href="http://localhost:1313/blog/cloudflare/">#Cloudflare</a>
  
  <a href="http://localhost:1313/blog/gravatar/">#Gravatar</a>
  
</p>

  </main>
  <footer>Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>
</footer>

  
</body>

</html>
