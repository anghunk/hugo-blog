<!DOCTYPE html>
<html lang="en">
	<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="generator" content="Hugo 0.146.5">
	<title>Github 仓库同步到 Cloudflare R2 - Manis</title>

	<meta name="description" content="我在 GitHub 搭建了一个图床，用于小量存储博客图片，为了稳定安全考虑，决定备份到 Cloudflare R2 存储桶一份，R2 默认有每月免费的 10G 存储、100 万次 A 类操作、1000 万次 B 类操作，备份完全足够了。
说到备份肯定是越自动化越好，手动上传是不可能的，因此我决定利用 GitHub Actions 执行自动任务。
话不多说，开始操作。
1. 建立 Cloudflare R2 存储桶
在 R2 页面新建一个存储桶，名称可以随意，就叫做 github-sync-imgurl，默认不公开就行了，这个不用调整。

然后在管理 R2 API 令牌中，创建一个新的 API 令牌，权限设为 管理员读和写，其他不用管默认设置，保存即可。
会生成一个 KEY_ID 和 ACCESS_KEY，这俩等会要用到，先记录一下。
2. GitHub 仓库设置
来到你需要备份的仓库，打开 Setting &gt; Actions &gt; General，勾选这两个设置然后保存，这个是必须的，否则 GitHub Actions 无法自动运行。

然后来到 Setting &gt; Secrets and variables &gt; Actions，点击 New repository secret 按钮开始创建密钥，按照下面的命名开始依次操作：
CLOUDFLARE_ACCOUNT_ID         #你的 Cloudflare 账户 ID
CLOUDFLARE_ACCESS_KEY_ID      # Cloudflare R2 的访问密钥 ID
CLOUDFLARE_SECRET_ACCESS_KEY  # Cloudflare R2 的秘密访问密钥
CLOUDFLARE_BUCKET_NAME        # 你在 Cloudflare R2 上的存储桶名称
图示如下：">


	
	
	




<link rel="stylesheet" href="/css/ui.css">

	
	

	<script defer src="/js/dark-mode.js"></script>
	<link disabled id="dark-mode-theme" rel="stylesheet" href="/css/dark.css">
	<link  rel="stylesheet" href="/css/dropdown.css">

	<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3973436778637330"
	crossorigin="anonymous"></script>

	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono">
	
				
	
</head>

<body>
<header class="container no-print">
	<div class="u-header">
		<nav class="bar">
	<ul><li>
			<a href="/">
				<img class="icon-text" src="/img/prev.svg"/>
			</a>
		</li><li><img class="icon-text" id="dark-mode-toggle" src="/img/moon-regular.svg" alt="Toggle Dark Mode"></a></li><li><a href="/about">About</a></li><li><a href="/post/">Post</a></li>





	</ul>
</nav>

	</div>
</header>
<main class="container">

<article>
	<header><hgroup id="brand">
	<h1>Github 仓库同步到 Cloudflare R2</h1>
	<h5>
		
		<time datetime="2024-08-25 00:00:00 &#43;0000 UTC">Aug 25, 2024 00:00</time>
		<span class="no-print">
			|
				
				<a href="/tags/GitHub">GitHub</a>
				
				<a href="/tags/Cloudflare">Cloudflare</a>
				<span>
	</h5>
	
</hgroup>
<hr class="sep" />
</header>
	<p>我在 GitHub 搭建了一个图床，用于小量存储博客图片，为了稳定安全考虑，决定备份到 Cloudflare R2 存储桶一份，R2 默认有每月免费的 10G 存储、100 万次 A 类操作、1000 万次 B 类操作，备份完全足够了。</p>
<p>说到备份肯定是越自动化越好，手动上传是不可能的，因此我决定利用 GitHub Actions 执行自动任务。</p>
<p>话不多说，开始操作。</p>
<h2 id="1-建立-cloudflare-r2-存储桶">1. 建立 Cloudflare R2 存储桶</h2>
<p>在 R2 页面新建一个存储桶，名称可以随意，就叫做 <code>github-sync-imgurl</code>，默认不公开就行了，这个不用调整。</p>
<p><img src="https://imgurl.zishu.me/2024/08/1724553937361.webp" alt=""></p>
<p>然后在管理 R2 API 令牌中，创建一个新的 API 令牌，权限设为 <code>管理员读和写</code>，其他不用管默认设置，保存即可。</p>
<p>会生成一个 <code>KEY_ID</code> 和 <code>ACCESS_KEY</code>，这俩等会要用到，先记录一下。</p>
<h2 id="2-github-仓库设置">2. GitHub 仓库设置</h2>
<p>来到你需要备份的仓库，打开 <code>Setting &gt; Actions &gt; General</code>，勾选这两个设置然后保存，这个是必须的，否则 GitHub Actions 无法自动运行。</p>
<p><img src="https://imgurl.zishu.me/2024/08/1724554184492.webp" alt=""></p>
<p>然后来到 <code>Setting &gt; Secrets and variables &gt; Actions</code>，点击 <code>New repository secret</code> 按钮开始创建密钥，按照下面的命名开始依次操作：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">CLOUDFLARE_ACCOUNT_ID         <span class="c1">#你的 Cloudflare 账户 ID</span>
</span></span><span class="line"><span class="cl">CLOUDFLARE_ACCESS_KEY_ID      <span class="c1"># Cloudflare R2 的访问密钥 ID</span>
</span></span><span class="line"><span class="cl">CLOUDFLARE_SECRET_ACCESS_KEY  <span class="c1"># Cloudflare R2 的秘密访问密钥</span>
</span></span><span class="line"><span class="cl">CLOUDFLARE_BUCKET_NAME        <span class="c1"># 你在 Cloudflare R2 上的存储桶名称</span>
</span></span></code></pre></div><p>图示如下：</p>
<p><img src="https://imgurl.zishu.me/2024/08/1724554376324.webp" alt=""></p>
<p>最后在 Actions 中新建一个新的任务，可以直接复制代码使用，无需修改，保存后运行即可。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Sync to Cloudflare R2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">cron</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;0 16 * * *&#39;</span><span class="w">  </span><span class="c"># 每天的16:00 UTC 时间触发（相当于东八区的 00:00）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workflow_dispatch</span><span class="p">:</span><span class="w">  </span><span class="c"># 允许手动触发</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sync</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Checkout code</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Install AWS CLI</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        sudo apt-get update
</span></span></span><span class="line"><span class="cl"><span class="sd">        sudo apt-get install -y awscli</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Configure AWS CLI for Cloudflare R2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        aws configure set aws_access_key_id ${{ secrets.CLOUDFLARE_ACCESS_KEY_ID }}
</span></span></span><span class="line"><span class="cl"><span class="sd">        aws configure set aws_secret_access_key ${{ secrets.CLOUDFLARE_SECRET_ACCESS_KEY }}
</span></span></span><span class="line"><span class="cl"><span class="sd">        aws configure set default.region auto</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Sync repository to Cloudflare R2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        aws s3 sync . s3://${{ secrets.CLOUDFLARE_BUCKET_NAME }} --endpoint-url=https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com --delete --exclude &#34;.git/*&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">CLOUDFLARE_ACCOUNT_ID</span><span class="p">:</span><span class="w"> </span><span class="l">${{ secrets.CLOUDFLARE_ACCOUNT_ID }}</span><span class="w">
</span></span></span></code></pre></div><p>由于使用了 <code>aws s3 sync</code> 命令，它会进行增量同步，这意味着它只会上传有变化的文件，而不会每次都重新上传整个仓库，避免消耗无用的 Cloudflare R2 流量。</p>

</article>
<nav class="no-print post-nav">

	<a class="prev-post" href="//localhost:1313/blog/weekly-64/">
		<img class="icon-text" src="/img/prev.svg"/>奇趣周刊 - 第 64 期</a>


	<a class="next-post" href="//localhost:1313/blog/weekly-65/">奇趣周刊 - 第 65 期<img class="icon-text" src="/img/next.svg"/>
	</a>

</nav>




	

<script src="https://utteranc.es/client.js"
        repo=""
        issue-term="url"
        label=""
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>



	

			<hr class="sep" />
		</main>
		<footer class="container no-print">
			<div class="u-footer">
				
<a href="mailto:mail@yurizal-san.com"><img class="icon-social" src="/img/email.svg" alt="Email Me!"/></a>


<a href="https://github.com/yursan9/"><img class="icon-social" src="/img/github.svg" alt="Github"/></a>



<a href="https://twitter.com/yuri_boya"><img class="icon-social" src="/img/twitter.svg" alt="Twitter"/></a>





				<p>
					
					Theme used: <a href="https://github.com/yursan9/manis-hugo-theme">Manis</a><br>
					
					
					&copy; 2019 Yurizal Susanto
					
					
					| <a href="/about/license">License</a>
					
				</p>
				
				<a href="#brand">
					<img class="icon-text" src="/img/toup.svg" alt="To Up"/>
					<span>Back to Up</span>
				</a>
				
			</div>
		</footer>
		
	</body>
</html>

