<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Lobechat 使用 Webdav 同步数据的研究 - JiaoYuan&#39;s blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="本文探讨如何利用 Webdav 技术在社区版 Lobechat 中实现数据同步，提供详细的操作流程及代码实现，帮助用户 在无额外成本下完成数据的云端备份与恢复。">

	

	
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	
	
	<link rel="stylesheet" href="/css/style.css">
	

	
	<link rel="dns-prefetch" href="https://api.github.com">

</head>
<body class="body">
	<div class="container container--outer">
		
	<div class="topbar">
		<a class="topbar__link" href="/" title="JiaoYuan&#39;s blog" rel="sidebar">
			<div class="topbar__item topbar__text">
					<div class="topbar__title">JiaoYuan&#39;s blog</div>
					<div class="topbar__tagline">思绪来得快去得也快，偶尔会在这里停留</div>
				</div>
		</a>
	</div>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Lobechat 使用 Webdav 同步数据的研究</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<time class="meta__text" datetime="2024-11-12T00:00:00Z">November 12, 2024</time></div></div>
		</header><div class="content post__content clearfix">
			<h2 id="1-前言">1. 前言</h2>
<p>Lobechat 就不做过多介绍了，一个开源、现代设计的人工智能聊天框架。</p>
<p>今天就来聊聊同步的问题，Lobechat 分为社区版和正式版，正式版需要付费订阅套餐，支持全局云同步，但是最便宜的套餐都要 4.9 刀，这让我 API 用户感觉有点难以接受。因为我需要的功能社区版都已经满足了，并不打算单独对云同步付费。</p>
<p>官方之前有通过 WebRTC 同步数据的方案，但在某个版本被废弃了，其实我也能理解，WebRTC 同步方案太过麻烦，且具有不稳定性，必须保证同时两台设备在线，而且实现原理让我感觉有一丝不安全性。</p>
<p>对 WebRTC 概念感兴趣的话可以看下官方的一篇文章：<br>
<a href="https://github.com/lobehub/lobe-chat/discussions/368">https://github.com/lobehub/lobe-chat/discussions/368</a></p>
<hr>
<p>其实除了正式版之外，还有服务器自建数据库等同步方法，但都需要一定的成本和技术壁垒。</p>
<p>因此我在社区版的基础上构思了一个脚本，通过 Webdav 技术实现对话记录、设置等同步。此方案成本基本为零，坚果云免费额度都绰绰有余。</p>
<h2 id="2-webdav--tampermonkey">2. Webdav / Tampermonkey</h2>
<p>但研究开始之前，有两个概念需要先了解一下。</p>
<ol>
<li>Webdav</li>
</ol>
<p>大多数网盘都支持通过 Webdav 技术进行同步，网盘会提供一套账号密码以及服务器地址，在前端调用 API，能够实现增删改查等操作。</p>
<ol start="2">
<li>油猴管理器（Tampermonkey）</li>
</ol>
<p>油猴管理器（Tampermonkey）无疑是浏览器插件的伟大创作之一，可以对网页注入 js 脚本来实现一些功能。</p>
<h2 id="3-那么如何获取-lobechat-数据呢">3. 那么如何获取 Lobechat 数据呢？</h2>
<p>我研究过 Lobechat 源码，它数据都存放在本地的 IndexedDB 数据库中，这是浏览器的一个存储机制，可以存放大量的数据，显示则是以数据库的格式。</p>
<p><img src="https://imgurl.zishu.me/2024/11/1731404378265.webp" alt=""></p>
<p>然后我先手动导出一份 json 格式的全局数据（社区版只支持手动导入导出文件），拿这份文件跟 IndexedDB 数据库 做对比，发现字段基本保持一致，数据格式也不用转，全部都在其中。</p>
<p>于是我翻阅了一下官方文档，有可以利用的 API，操作查询这些数据，下面是我的一些思路。</p>
<p>先声明我想要拿到的数据，这些都在上面的截图中存在。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">dbName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;LOBE_CHAT_DB&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">storeNames</span> <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;messages&#34;</span>, <span style="color:#e6db74">&#34;sessionGroups&#34;</span>, <span style="color:#e6db74">&#34;sessions&#34;</span>, <span style="color:#e6db74">&#34;topics&#34;</span>, <span style="color:#e6db74">&#34;users&#34;</span>];
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">request</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">indexedDB</span>.<span style="color:#a6e22e">open</span>(<span style="color:#a6e22e">dbName</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">onsuccess</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">event</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">db</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">state</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">messages</span><span style="color:#f92672">:</span> [],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sessionGroups</span><span style="color:#f92672">:</span> [],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sessions</span><span style="color:#f92672">:</span> [],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">topics</span><span style="color:#f92672">:</span> [],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">users</span><span style="color:#f92672">:</span> [],
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">pendingStores</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">storeNames</span>.<span style="color:#a6e22e">forEach</span>((<span style="color:#a6e22e">storeName</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">objectStoreNames</span>.<span style="color:#a6e22e">contains</span>(<span style="color:#a6e22e">storeName</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pendingStores</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">transaction</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">transaction</span>([<span style="color:#a6e22e">storeName</span>], <span style="color:#e6db74">&#34;readonly&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">objectStore</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">transaction</span>.<span style="color:#a6e22e">objectStore</span>(<span style="color:#a6e22e">storeName</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">allRecords</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">objectStore</span>.<span style="color:#a6e22e">getAll</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">allRecords</span>.<span style="color:#a6e22e">onsuccess</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">event</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">state</span>[<span style="color:#a6e22e">storeName</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pendingStores</span><span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">pendingStores</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">          * 整个数据库的数据都可以导出
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">          * 在此回调执行操作
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">          */</span> 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h2 id="4-操作流程原型">4. 操作流程原型</h2>
<p>既然可以查询，就可以覆盖，同样也有 API 支持，所以我就构思了一下流程，利用 Webdav 的增删改查，把这些数据传到网盘中，然后在另一台设备拉取，最后优化一下整个流程，让它更加可视化。</p>
<p>大致原型如下：</p>
<p><img src="https://imgurl.zishu.me/2024/11/1731404855162.webp" alt=""></p>
<p>点击同步到云端，会通过 Webdav API 在网盘创建一个指定的文件夹 <code>lobechat-webdav-backup</code>(我自己随意命名的)，在本地程序中生成一个 json 文件，IndexedDB 数据会被放入该文件中，然后通过 Webdav API 传输到网盘中。</p>
<p>点击下载到本地，会先通过 Webdav API 获取<code>lobechat-webdav-backup</code>下的 json 文件内容，利用 IndexedDB API 覆盖在浏览器 IndexedDB 数据库中。</p>
<hr>
<p>在实际体验中，可以随时保存本地数据到云端，下载数据到本地，同步就很方便，使用了三天，没有出现同步出错的问题，脚本很稳定。</p>
<p>最终我把该脚本发布到 Greasyfork，可供大家直接使用，代码也已开源。</p>
<ul>
<li>安装：<a href="https://greasyfork.org/scripts/516358">https://greasyfork.org/scripts/516358</a></li>
<li>Github：<a href="https://github.com/anghunk/UserScript">https://github.com/anghunk/UserScript</a></li>
</ul>

		</div>
	</article>
</main>



			</div>
			
		</div>
	</div>
	
	<script src="/js/search.js" defer></script>
	<script src="/js/archives.js" defer></script>
	<script src="/js/lazyload.js" defer></script>
	
	
</body>
</html>